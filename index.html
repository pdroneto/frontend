<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>
	<h2 id="titulo">Cadastrar Aluno</h2>
	<div><label>Nome:</label><input id="nome" type="text"></div>
	<div><label>Sobrenome:</label><input id="sobrenome" type="text"></div>
	<div><label>Telefone:</label><input id="telefone" type="text"></div>
	<div><label>RA:</label><input id="ra" type="text"></div>
	<div>
		<button id="btnSalvar" onclick="Cadastrar()">Cadastrar</button>
		<button id="btnCancelar" onclick="Cancelar()">Limpar</button>
	</div>
	<table border="1">
		<thead>
			<tr>
				<td>Nome</td>
				<td>Sobrenome</td>
				<td>Telefone</td>
				<td>RA</td>
				<td>Opções</td>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>
	<script type="text/javascript">
	var tbody = document.querySelector('table tbody');
	var aluno = {};
		/*-------------------------------------------------------------------------------------------*/
	/* a função cadastrar vai buscar dentro do meu documento html os valores que estão em cada elemento
	do meu arquivo como: nome, sobrenome, telefone e ra, por isso é importante que cada input que foi
	colocado no HTML tenha um id, pois é através do id que é possível localizar o componente no HTML*/
		function Cadastrar() {
			aluno.nome = document.querySelector('#nome').value;
			aluno.sobrenome = document.querySelector('#sobrenome').value;
			aluno.telefone = document.querySelector('#telefone').value;
			aluno.ra = document.querySelector('#ra').value;

			if(aluno.id === undefined || aluno.id === 0){
				carregaEstudantes('POST', 0, aluno);
			
			}else{
				carregaEstudantes('PUT', aluno.id, aluno);
			}
			

			carregaEstudantes('GET');

		}

		function Cancelar()
			{
			var btnSalvar = document.querySelector('#btnSalvar');
			var btnCancelar = document.querySelector('#btnCancelar');
			var titulo = document.querySelector('#titulo');		

			document.querySelector('#nome').value = '' ;
			document.querySelector('#sobrenome').value = '' ;
			document.querySelector('#telefone').value = '' ;
			document.querySelector('#ra').value = '' ;

			btnSalvar.textContent = 'Cadastrar';
			btnCancelar.textContent = 'Limpar';
			titulo.textContent = 'Cadastrar Aluno';
				

		}

		function editarEstudante(estudante){
			var btnSalvar = document.querySelector('#btnSalvar');
			var btnCancelar = document.querySelector('#btnCancelar');
			var titulo = document.querySelector('#titulo');
			
			document.querySelector('#nome').value = estudante.nome ;
			document.querySelector('#sobrenome').value = estudante.sobrenome ;
			document.querySelector('#telefone').value = estudante.telefone ;
			document.querySelector('#ra').value = estudante.ra ;

			btnSalvar.textContent = 'Salvar';
			btnCancelar.textContent = 'Cancelar';
			titulo.textContent = `Editar Aluno ${estudante.nome}`;

			aluno = estudante;

		}

		/*-------------------------------------------------------------------------------------------*/
		/* a função abaixo é para carregar os estudantes dentro da tabela, é necessário 
		que você mude o endereço do localhost para o endereço do localhost da sua máquina

		*/
		/*-------------------------------------------------------------------------------------------*/
		function carregaEstudantes(metodo, id, corpo) {
			tbody.innerHTML = '';
			/*Primeira coisa que foi feita é o seguinte:
			Foi criado um objeto xhr instanciado com o XMLHttpRequest. Esse objeto será o resposável
			por maniular as nossas chamadas, esse é o famoso Ajax
			*/		
			var xhr = new XMLHttpRequest();

			if(id === undefined || id === 0)
			id = '';

			/*Eu faço esse teste para verificar se o id que foi passado é idefinido ou se ele é zero, eu utilizo === para verificar tanto o tipo
			quanto no valor*/
			/*Antes de enviar os comandos do AJAX é necessário fazer a configuração necessária
				Vou chamar a URL utilizando o método GET, passo a URL da aplicação e marco no final como true
				para chamar essa função de forma sincrona*/	
			xhr.open(metodo, `http://localhost:57825/api/Aluno/${id}`, true);

			/*Nessa parte vamos carregar nosso objeto xhr utilizando uma função anônima
				Aqui funciona assim: Se o comando anterior for verdadeiro, eu carregar no console.log o texto
				que vier da chamada, porém eu quero que o texto seja convertido em JSON*/
			xhr.onload = function () {
				var estudantes = JSON.parse(this.responseText);

				/*Foi criado um laço do tipo for que chama a função adicionaLinha para cada estudante retornado
				 */
				for(var indice in estudantes){
					adicionaLinha(estudantes[indice]);
				}
			}	
			if(corpo !== undefined){
				xhr.setRequestHeader('content-type', 'application/json');
				xhr.send(JSON.stringify(corpo));
				}
				else{
					xhr.send();	
				}
			}

			//Aqui eu chamo a função para que na hora que a página é iniciada os dados do meu json já sejam caregados na tabela

		carregaEstudantes('GET');
		/*-------------------------------------------------------------------------------------------*/
	

		/*-------------------------------------------------------------------------------------------*/
		/* Eu criei uma função para adicionar linha dentro da minha função de CarregaEstudantes()
		Ela recebe como parâmetro o estudante*/
		function adicionaLinha(estudante) {
			var tbody = document.querySelector('table tbody');
		/* Abaixo eu estou preparando cada linha da minha tabela com os valores que estão retornando
		do meu JSON*/	
			var trow = `<tr>
							<td>${estudante.nome}</td>
							<td>${estudante.sobrenome}</td>
							<td>${estudante.telefone}</td>
							<td>${estudante.ra}</td>
							
							<td><button onclick='editarEstudante(${JSON.stringify(estudante)})'>Editar</button></td>
					    </tr>
					   `
					   /*Foi necessário realizar a conversão do estudante de um objeto para uma string mantendo o formato JSON,
					   isso é necessário porque eu enviarei todos os dados para o HTMl e este não consegue interpretar objetos, apenas
					   textos. */
			/*Aqui eu insiro o conteúdo da variável trow no HTML*/		   
			tbody.innerHTML += trow;
		}
		/*-------------------------------------------------------------------------------------------*/
	</script>
</body>
</html>